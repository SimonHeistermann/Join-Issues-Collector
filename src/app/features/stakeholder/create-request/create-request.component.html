<div class="stakeholder-page">
  <!-- Header -->
  <header class="stakeholder-header">
    <div class="header-logo-row">
      <a routerLink="/welcome" class="logo-link">
        <img src="assets/icons/logo_blue.png" alt="Join" class="logo" />
      </a>
    </div>

    <div class="header-nav-row">
      <button class="back-button" (click)="goBack()">
        <img src="assets/icons/arrow_left_blue.png" alt="Back" />
      </button>

      <div class="usage-display">
        <span class="usage-count">{{ usedRequests() }}</span>
        <span class="usage-text">of <strong>10</strong> requests used today</span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="stakeholder-content">
    <!-- Desktop Title -->
    <h1 class="main-title desktop-only">Create Request</h1>

    <!-- Mobile Title Row -->
    <div class="mobile-title-row">
      <div class="mobile-title-left">
        <h1 class="main-title">Create Request</h1>
        <div class="mobile-usage-display">
          <span class="usage-count">{{ usedRequests() }}</span>
          <span class="usage-text">of <strong>10</strong> requests used</span>
        </div>
      </div>
      <button class="mobile-back-button" (click)="goBack()">
        <img src="assets/icons/arrow_left_blue.png" alt="Back" />
      </button>
    </div>

    <!-- Form Card -->
    <div class="form-card">
      <form class="request-form" (submit)="handleSubmit($event)">
        <!-- Name -->
        <div class="input-container">
          <label><h3>Your Name<span class="red-star">*</span></h3></label>
          <div class="input-box">
            <input type="text" [(ngModel)]="name" name="name" placeholder="Enter your name"
              (blur)="markTouched('name')" (keydown)="handleKeyDown($event)"
              [class.error-input]="nameError">
            <div class="error-message">{{ nameError }}</div>
          </div>
        </div>

        <!-- Email -->
        <div class="input-container">
          <label><h3>Email Address<span class="red-star">*</span></h3></label>
          <div class="input-box">
            <input type="email" [(ngModel)]="email" name="email" placeholder="Enter your email address"
              (blur)="markTouched('email')" (keydown)="handleKeyDown($event)"
              [class.error-input]="emailError">
            <div class="error-message">{{ emailError }}</div>
          </div>
        </div>

        <!-- Title -->
        <div class="input-container">
          <label><h3>Request Title<span class="red-star">*</span></h3></label>
          <div class="input-box">
            <input type="text" [(ngModel)]="title" name="title" placeholder="Enter a title for your request"
              (blur)="markTouched('title')" (keydown)="handleKeyDown($event)"
              [class.error-input]="titleError">
            <div class="error-message">{{ titleError }}</div>
          </div>
        </div>

        <!-- Description -->
        <div class="input-container">
          <label><h3>Description<span class="red-star">*</span></h3></label>
          <div class="input-box">
            <textarea rows="5" [(ngModel)]="description" name="description"
              placeholder="Describe your request in detail"
              (blur)="markTouched('description')" (keydown)="handleKeyDown($event)"
              [class.error-input]="descriptionError"></textarea>
            <div class="error-message">{{ descriptionError }}</div>
          </div>
        </div>

        <!-- Priority -->
        <div class="input-container">
          <h3>Priority</h3>
          <div class="radio-container">
            <label class="radio radio-urgent">
              <input type="radio" name="prio" [value]="3" [(ngModel)]="priority">
              <h3>Urgent</h3>
              <img class="urgent-icon-red" src="assets/icons/urgent_icon_red.png" alt="Urgent">
              <img class="urgent-icon-white" src="assets/icons/urgent_icon_white.png" alt="Urgent">
            </label>
            <label class="radio radio-medium">
              <input type="radio" name="prio" [value]="2" [(ngModel)]="priority">
              <h3>Medium</h3>
              <img class="medium-icon-orange" src="assets/icons/medium_icon_orange.png" alt="Medium">
              <img class="medium-icon-white" src="assets/icons/medium_icon_white.png" alt="Medium">
            </label>
            <label class="radio radio-low">
              <input type="radio" name="prio" [value]="1" [(ngModel)]="priority">
              <h3>Low</h3>
              <img class="low-icon-green" src="assets/icons/low_icon_green.png" alt="Low">
              <img class="low-icon-white" src="assets/icons/low_icon_white.png" alt="Low">
            </label>
          </div>
        </div>

        <!-- Category -->
        <div class="dropdown-container">
          <h3>Category<span class="red-star">*</span></h3>
          <div class="dropdown-content">
            @if (!categoryDropdownOpen) {
              <button type="button" class="dropdown-toggle" [class.error-input]="categoryError"
                (click)="toggleCategoryDropdown($event)">
                <h3 [class.selected-category]="category !== ''">{{ getCategoryLabel() }}</h3>
                <span class="dropdown-arrow-icon-container">
                  <img class="dropdown-arrow-icon-default" src="assets/icons/arrow_drop_down_icon.png" alt="Open">
                  <img class="dropdown-arrow-icon-hover" src="assets/icons/arrow_drop_down_icon_hover.png" alt="Open">
                </span>
              </button>
            } @else {
              <div class="dropdown-search-container">
                <h3>Select task category</h3>
                <button type="button" class="close-dropdown-button" (click)="toggleCategoryDropdown($event)">
                  <img class="dropdown-arrow-up-icon-default" src="assets/icons/arrow_drop_down_up_icon.png" alt="Close">
                  <img class="dropdown-arrow-up-icon-hover" src="assets/icons/arrow_drop_down_up_icon_hover.png" alt="Close">
                </button>
              </div>
            }
            <div class="dropdown-list-wrapper category-dropdown" [class.open]="categoryDropdownOpen">
              @if (categoryDropdownOpen) {
                <div class="overlay-dropdown" (click)="closeCategoryDropdown()"></div>
              }
              <ul class="dropdown-list">
                <li class="dropdown-item-category" (click)="selectCategory('tt')">
                  <span>Technical Task</span>
                </li>
                <li class="dropdown-item-category" (click)="selectCategory('us')">
                  <span>User Story</span>
                </li>
              </ul>
            </div>
          </div>
          <div class="error-message">{{ categoryError }}</div>
        </div>

        <!-- Due Date -->
        <div class="input-container">
          <h3>Due Date <span class="optional-label">(optional)</span></h3>
          <div class="date-container" [class.error-input]="dateError">
            <input class="date-input" type="date" [(ngModel)]="dueDate" name="dueDate"
              [min]="getTodayDate()" (blur)="markTouched('dueDate')">
          </div>
          <div class="error-message">{{ dateError }}</div>
        </div>

        <!-- Subtasks -->
        <div class="subtasks-container">
          <h3>Subtasks <span class="optional-label">(optional)</span></h3>
          <div class="date-container subtask-input-container">
            <input class="date-input" type="text" [(ngModel)]="newSubtaskText" name="newSubtask"
              placeholder="Add new subtask" (click)="activateSubtaskInput()"
              (keydown)="handleSubtaskKeydown($event)">
            <label class="add-subtask-label">
              @if (!subtaskInputActive) {
                <button type="button" class="add-subtask-box" (click)="activateSubtaskInput()">
                  <img class="add-subtask-icon" src="assets/icons/add_icon_blue.png" alt="+">
                  <img class="add-subtask-icon-hover" src="assets/icons/add_icon_blue_hover.png" alt="+">
                </button>
              } @else {
                <div class="active-add-subtask-box">
                  <button type="button" class="close-subtask-box" (click)="closeSubtaskInput()">
                    <img class="close-subtask-icon" src="assets/icons/close_icon_subtask_blue.png" alt="X">
                    <img class="close-subtask-icon-hover" src="assets/icons/close_icon_subtask_blue_hover.png" alt="X">
                  </button>
                  <div class="add-subtask-separator"></div>
                  <button type="button" class="check-subtask-box" (click)="addSubtask()">
                    <img class="check-subtask-icon" src="assets/icons/hook_icon_subtask_blue.png" alt="OK">
                    <img class="check-subtask-icon-hover" src="assets/icons/hook_icon_subtask_blue_hover.png" alt="OK">
                  </button>
                </div>
              }
            </label>
          </div>
          <div class="added-subtasks-container">
            @for (subtask of subtasks; track subtask.id) {
              @if (editingSubtaskId === subtask.id) {
                <div class="subtask-item-edited">
                  <input class="subtask-edit-input" type="text" [(ngModel)]="editingSubtaskText"
                    [ngModelOptions]="{standalone: true}" (keydown)="handleEditSubtaskKeydown($event, subtask)">
                  <label>
                    <button type="button" class="delete-subtask-box-hover" (click)="deleteSubtask(subtask.id)">
                      <img class="delete-subtask-icon" src="assets/icons/delete_icon_subtask_blue.png" alt="Delete">
                      <img class="delete-subtask-icon-hover" src="assets/icons/delete_icon_subtask_blue_hover.png" alt="Delete">
                    </button>
                    <div class="add-subtask-separator"></div>
                    <button type="button" class="check-subtask-box-hover" (click)="saveEditSubtask(subtask)">
                      <img class="check-subtask-icon" src="assets/icons/hook_icon_subtask_blue.png" alt="OK">
                      <img class="check-subtask-icon-hover" src="assets/icons/hook_icon_subtask_blue_hover.png" alt="OK">
                    </button>
                  </label>
                </div>
              } @else {
                <div class="subtask-item">
                  <div class="subtask-item-left">
                    <span>&bull;</span>
                    <span>{{ subtask.name }}</span>
                  </div>
                  <div class="edit-and-delete-subtask-box">
                    <button type="button" class="edit-subtask-box-hover" (click)="startEditSubtask(subtask)">
                      <img class="edit-subtask-icon" src="assets/icons/edit_icon_subtask_blue.png" alt="Edit">
                      <img class="edit-subtask-icon-hover" src="assets/icons/edit_icon_subtask_blue_hover.png" alt="Edit">
                    </button>
                    <div class="add-subtask-separator"></div>
                    <button type="button" class="delete-subtask-box-hover" (click)="deleteSubtask(subtask.id)">
                      <img class="delete-subtask-icon" src="assets/icons/delete_icon_subtask_blue.png" alt="Delete">
                      <img class="delete-subtask-icon-hover" src="assets/icons/delete_icon_subtask_blue_hover.png" alt="Delete">
                    </button>
                  </div>
                </div>
              }
            }
          </div>
        </div>

        <!-- Privacy Checkbox -->
        <div class="privacy-container">
          <label class="privacy-label" (click)="privacyAccepted = !privacyAccepted; markTouched('privacy')">
            <span class="privacy-checkbox" [class.checked]="privacyAccepted"
              [class.error-checkbox]="privacyError"></span>
            <span class="privacy-text">
              I accept the <a routerLink="/privacy-policy" (click)="$event.stopPropagation()">Privacy Policy</a><span class="red-star">*</span>
            </span>
          </label>
          <div class="error-message">{{ privacyError }}</div>
        </div>

        <!-- Required Info + Buttons -->
        <div class="form-footer">
          <div class="is-required-text">
            <span class="red-star">*</span>
            This field is required
          </div>
          <div class="button-box">
            <button type="button" class="clear-button" (click)="clearForm()">
              Clear
              <img class="clear-button-img" src="assets/icons/cancel_icon_blue.png" alt="Clear">
              <img class="clear-button-img-hover" src="assets/icons/cancel_icon_lightblue.png" alt="Clear">
            </button>
            <button type="submit" class="submit-button" [disabled]="submitting || !isFormValid">
              {{ submitting ? 'Submitting...' : 'Submit Request' }}
              <img src="assets/icons/hook_icon_white.png" alt="Submit">
            </button>
          </div>
        </div>
        <!-- Error Banner -->
        @if (showError_) {
          <div class="error-banner">
            {{ errorMessage }}
          </div>
        }
      </form>
    </div>
  </main>

  <!-- Footer -->
  <footer class="stakeholder-footer">
    <a routerLink="/privacy-policy">Privacy Policy</a>
    <a routerLink="/legal-notice">Legal notice</a>
  </footer>
</div>

<!-- Success Notification -->
@if (showNotification) {
  <div class="overlay-success">
    <div class="success-notification">
      <h3>Request submitted successfully</h3>
      <img src="assets/icons/check_icon_white.png" alt="Success">
    </div>
  </div>
}
